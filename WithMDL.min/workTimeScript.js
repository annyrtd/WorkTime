function IsReportOnPage(){var e=!1;return $("th.time").each(function(t){"Отчет"==$(this).text()&&(e=!0)}),e}function RemoveColumnsWhenReportIsOnPage(){HideCellsInTableHead(),HideCellsInTableBody()}function HideCellsInTableHead(){$("th.time").each(function(e){0!=e&&e!=$("th.time").length-1&&($(this).hide(),$("td.dayoff").attr("colspan",$("td.dayoff").attr("colspan")-1))})}function HideCellsInTableBody(){var e=$("th.time").length-3;$("tbody > tr").each(function(t){var n=$(this).children("td.time").length-1;$(this).children("td.time").each(function(e){0!=e&&e!=n&&$(this).hide()}),"future"==$(this).attr("class")&&($(this).children("td.time").hide(),$(this).children().not("td[class]").each(function(t){e>t&&$(this).hide()}))})}function RemoveColumnsWhenThereIsNoReport(){HideAllCellsInTableHeadWhenNoReport(),HideAllCellsInTableBodyWhenNoReport(),AddReportColumn()}function HideAllCellsInTableHeadWhenNoReport(){$("th.time").each(function(e){0!=e&&($(this).hide(),$("td.dayoff").attr("colspan",$("td.dayoff").attr("colspan")-1))})}function HideAllCellsInTableBodyWhenNoReport(){var e=$("th.time").length-2;$("tbody > tr").each(function(t){$(this).children("td.time").each(function(e){0!=e&&$(this).hide()}),"future"==$(this).attr("class")&&($(this).children("td.time").hide(),$(this).children().not("td[class]").each(function(t){e>t&&$(this).hide()}))})}function AddReportColumn(){var e=$("<th></th>",{"class":"time"}).append("Отчет");$("th.time").last().after(e),$("tr[id]").not("[class=future]").each(function(e){var t=DifferenceOfTime($(this).children("td.time").first().text(),"00:30"),n=$("<td></td>",{"class":"time"}).append(t);$(this).children("td.time").last().after(n)}),$("td.dayoff").attr("colspan",+$("td.dayoff").attr("colspan")+1)}function CreateFlex(){var e=$("<div></div>",{"class":"flexParent"}).append($("table.full-size"));$(".mdl-layout__content").append(e)}function AddConclusionForMonth(){var e=GetAlreadyWorkedTimeForMonth();void 0!==$("#NetTime")&&"Yes"==$("#NetTime").children("option[selected]").val()&&(e=SumOfTime(e,GetTimeOfHolidays()));var t,n=GetCurrentTimeForCurrentDay(),i=DifferenceOfTime(GetTimeForMonthLeft(),n),r=GetSumReportTimeForMonth();t=n.indexOf("-")>-1?"notEnoughWorkTime":"enoughWorkTime";var o=$("<label></label>",{id:"text_currentTime"}).append("Отработанное время за месяц: "),a=$("<label></label>",{id:"currentTime"}).append(e),s=$("<label></label>",{id:"text_thisDayLeft","class":t}).append("Остаток на текущий день: "),d=$("<label></label>",{id:"thisDayLeft","class":t}).append(n),l=$("<label></label>",{id:"text_timeForMonthOrWeekLeft"}).append("Остаток до конца месяца: "),c=$("<label></label>",{id:"timeForMonthOrWeekLeft"}).append(i),f=$("<label></label>",{id:"text_reportTimeForMonth"}).append("Нужно отработать за месяц: "),h=$("<label></label>",{id:"reportTimeForMonth"}).append(r),u=$("<div></div>",{"class":"conclusion month mdl-card mdl-shadow--2dp"}).append("<div><b>Статистика:</b></div>").append(s,d).append("<br>",l,c).append("<br>","<br>",o,a).append("<br>",f,h,"<br>");$(".flexParent").append(u),0==$(".future").length&&($("#text_timeForMonthOrWeekLeft").hide(),$("#timeForMonthOrWeekLeft").hide(),$("#timeForMonthOrWeekLeft").next().hide(),$("#text_reportTimeForMonth").hide(),$("#reportTimeForMonth").hide(),$("#reportTimeForMonth").next().hide())}function GetAlreadyWorkedTimeForMonth(){var e=$(".summary").last().children(".time").first().text();return $("tr[id]").not("[class=future]").each(function(t){e=DifferenceOfTime(e,"00:30")}),e}function GetAlreadyWorkedTimeForMonth_ForStudent(){return $(".summary").last().children(".time").first().text()}function GetTimeOfHolidays(){var e=8*$("tr.dayoff").length;return Pad(e,2)+":00"}function GetCurrentTimeForCurrentDay(){return $(".summary:contains('Итог')").not(":contains('за месяц')").last().children(".time").eq(2).text()}function GetTimeForMonthLeft(){var e="00:00";return $("tr.future > td.time").each(function(t){e=SumOfTime(e,$(this).text())}),e}function GetSumReportTimeForMonth(){var e="00:00";return $("tr.future > td.time").each(function(t){e=SumOfTime(e,DifferenceOfTime($(this).text(),"00:30"))}),$("tr[id]").not("[class=future]").each(function(t){e=SumOfTime(e,DifferenceOfTime($(this).children(".time").eq(1).text(),"00:30"))}),e}function GetSumReportTimeForMonth_ForStudent(){var e="00:00";return $("tr.future > td.time").each(function(t){e=SumOfTime(e,$(this).text())}),$("tr[id]").not("[class=future]").each(function(t){e=SumOfTime(e,$(this).children(".time").eq(1).text())}),e}function RemoveConclusionForMonth(){$(".flexParent .barrier").remove(),$(".conclusion.month").remove()}function AddConclusionForWeek(){var e=GetCurrentTimeForWeek();void 0!==$("#NetTime")&&"Yes"==$("#NetTime").children("option[selected]").val()&&(e=SumOfTime(e,GetTimeOfHolidaysForWeek()));var t,n=GetCurrentTimeForCurrentDay(),i=GetTimeForWeekLeft();t=n.indexOf("-")>-1?"notEnoughWorkTime":"enoughWorkTime";var r=$("<label></label>",{id:"text_currentTime_week"}).append("Отработанное время за неделю: "),o=$("<label></label>",{id:"currentTime_week"}).append(e),a=$("<label></label>",{id:"text_thisDayLeft_week","class":t}).append("Остаток на текущий день: "),s=$("<label></label>",{id:"thisDayLeft_week","class":t}).append(n),d=$("<label></label>",{id:"text_timeForMonthOrWeekLeft_week"}).append("Остаток до конца недели: "),l=$("<label></label>",{id:"timeForMonthOrWeekLeft_week"}).append(i),c=$("<div></div>",{"class":"conclusion week mdl-card mdl-shadow--2dp"}).append("<div><b>Статистика:</b></div>").append(a,s).append("<br>",d,l).append("<br>","<br>",r,o,"<br>");$(".flexParent").append(c)}function GetCurrentTimeForWeek(){var e="00:00";return $("tr[id]").not("[class=future]").not('[style="display: none;"]').each(function(t){e=SumOfTime(e,DifferenceOfTime($(this).children(".time").first().text(),"00:30"))}),e}function GetCurrentTimeForWeek_ForStudent(){var e="00:00";return $("tr[id]").not("[class=future]").not('[style="display: none;"]').each(function(t){e=SumOfTime(e,$(this).children(".time").first().text())}),e}function GetTimeOfHolidaysForWeek(){var e=8*$("tr.dayoff").not('[style="display: none;"]').length;return Pad(e,2)+":00"}function GetTimeForWeekLeft(){var e="00:00",t="00:00";return $("tr[id]").not("[class=future]").not('[style="display: none;"]').each(function(n){t=SumOfTime(t,$(this).children(".time").first().text()),e=SumOfTime(e,$(this).children(".time").eq(1).text())}),DifferenceOfTime(t,e)}function RemoveConclusionForWeek(){$(".flexParent .barrier").remove(),$(".conclusion.week").remove()}function SumOfTime(e,t){if(e.toString().indexOf("-")>-1&&t.toString().indexOf("-")>-1)return"-"+SumOfTime(e.substr(1),t.substr(1));if(e.toString().indexOf("-")>-1)return DifferenceOfTime(t,e.substr(1));if(t.toString().indexOf("-")>-1)return DifferenceOfTime(e,t.substr(1));var n=+e.indexOf(":"),i=+t.indexOf(":"),r=+e.substr(0,n),o=+t.substr(0,i),a=+e.substr(n+1),s=+t.substr(i+1),d=+(r+o)+Math.floor((a+s)/60),l=+(a+s)%60;return Pad(d,2)+":"+Pad(l,2)}function Pad(e,t){for(var n=e+"";n.length<t;)n="0"+n;return n}function DifferenceOfTime(e,t){if(e.toString().indexOf("-")>-1&&t.toString().indexOf("-")>-1)return DifferenceOfTime(t.substr(1),e.substr(1));if(e.toString().indexOf("-")>-1)return"-"+SumOfTime(e.substr(1),t);if(t.toString().indexOf("-")>-1)return SumOfTime(e,t.substr(1));var n,i,r=+e.indexOf(":"),o=+t.indexOf(":"),a=+e.substr(0,r),s=+t.substr(0,o),d=+e.substr(r+1),l=+t.substr(o+1);return s>a?(n=+(s-a)+Math.floor((l-d)/60),i=+(l-d),d>l&&(i+=60),n.toString().indexOf("-")>-1?n=n.toString().substr(1):(0!=n||0!=i)&&(n="-"+n)):a>s?(n=+(a-s)+Math.floor((d-l)/60),i=+(d-l),l>d&&(i+=60)):d>=l?(n="00",i=+(d-l)):(n="-0",i=+(l-d)),Pad(n,2)+":"+Pad(i,2)}function SeparateStartAndFinish(){var e=$("<th></th>",{"class":"text range"}).append("Окончание");$("th.text.range").text("Начало").after(e),$("td.range.text").each(function(){var e,t="",n="",i="",r="",o="";$(this).children("span").each(function(){o=$(this).text(),e=o.indexOf("—"),e>-1&&(i=o.substr(0,e),r=o.substr(e+1),t+=i+"<br>",n+=""==r?"&nbsp;...&nbsp;<br>":r+"<br>")});var a=$("<td></td>",{"class":"range text"}).append(n);if($(this).children("span").hasClass("remote")){var s=$("<span></span>",{"class":"remote"}).append(a.text());a.empty().append(s),t=$("<span></span>",{"class":"remote"}).append(t)}$(this).empty().append(t).after(a),""==$(this).text()&&AddWarningForEmptyTime.apply($(this).get(0),["прихода"]),""==$(this).next().text()&&AddWarningForEmptyTime.apply($(this).next().get(0),["ухода"])});var t=$("td.dayoff").attr("colspan");$("td.dayoff").attr("colspan",++t),$("td.text[colspan]").each(function(e){t=$(this).attr("colspan"),$(this).attr("colspan",++t)}),$("tr.future").each(function(e){var t=$("<td></td>");$(this).append(t)})}function AddWarningForEmptyTime(e){$(this).append('<i class="material-icons" style="color: gray;" title="Не зарегистрировано время '+e+'">warning</i>')}function RemoveUnnesessaryBlocks(){$(".future").hide(),$(".summary").hide()}function AddRowBetweenWeeksWithWeekNumber(){var e=+$("th").not("[style='display: none;']").length+1;AddFirstRowBetweenWeeks(e);var t=2;$("tr[id], tr.dayoff").not("[class=future]").each(function(n){if("Пн"==$(this).children().first().text()&&"intervalRow"!=$(this).prev().attr("class")){titleOfWeek=t+"-я неделя.";var i=$("<td></td>",{"class":"intervalCell",colspan:e}).append(titleOfWeek);t++;var r=$("<tr></tr>",{"class":"intervalRow"}).append(i);$(this).before(r)}}),DivideDayoffIntoParts()}function AddFirstRowBetweenWeeks(e){var t=$("<td></td>",{"class":"intervalCell",colspan:e}).append("1-я неделя."),n=$("<tr></tr>",{"class":"intervalRow"}).append(t);$("tbody").prepend(n)}function DivideDayoffIntoParts(){$("tr.intervalRow").each(function(e){if("dayoff"==$(this).prev().attr("class")&&"dayoff"==$(this).next().attr("class")&&0==$(this).next().children("td.dayoff").length){var t=$("td.dayoff").first().clone();$(this).next().append(t)}}),$("td.dayoff").attr("colspan","5").each(function(e){var t=1;$(this).parent().nextUntil(".intervalRow").filter("tr.dayoff").each(function(e){return 0!=$(this).children("td.dayoff").length?!1:void t++}),$(this).attr("rowspan",t)})}function WriteFullNamesOfDays(){$("td.weekday").each(function(e){switch($(this).text()){case"Пн":$(this).text("Понедельник");break;case"Вт":$(this).text("Вторник");break;case"Ср":$(this).text("Среда");break;case"Чт":$(this).text("Четверг");break;case"Пт":$(this).text("Пятница");break;case"Сб":$(this).text("Суббота");break;case"Вс":$(this).text("Воскресенье")}})}function CreateSettings(){$("div.mdl-layout__drawer").append($("<div id=settings></div>")),$("#settings").load("http://co-msk-app02/Preferences/Edit form",function(){$("#settings").hide(),$("div.table-form").eq(0).remove(),$("#settings").prepend("<br><label><b>Настройки:</b></label><br><br>"),$("#ReturnTo").val("/Personal"+window.location.search),$("#settings a").hide(),$("#settings label").removeAttr("for"),$("#settings label").after("<br>"),$("div.table-form").last().next().css({paddingTop:"2em"}),$("div.table-form").eq(0).children("label").text('Округлять "отчетное" время'),$("div.table-form").eq(1).children("label").text("Учитывать отпуск в отработанном времени за месяц"),$("div.table-form").eq(2).children("label").text("Я студент"),$("div.table-form").eq(4).children("label").text("Cчитать отчетное время до конца месяца"),$("div.table-form").eq(3).hide(),"Yes"==$("div.table-form").eq(1).children("select").first().children("option[selected]").val()?($("#currentTime").text(SumOfTime(GetAlreadyWorkedTimeForMonth(),GetTimeOfHolidays())),$("#currentTime_week").text(SumOfTime(GetCurrentTimeForWeek(),GetTimeOfHolidaysForWeek()))):($("#currentTime").text(GetAlreadyWorkedTimeForMonth()),$("#currentTime_week").text(GetCurrentTimeForWeek())),"Yes"==$("div.table-form").eq(2).children("select").first().children("option[selected]").val()&&(isStudent=!0,SetUpTimeForStudent()),ReplaceInput.apply($("form[action='/Preferences/Edit'] input[type=submit]").get(0)),ChangeButtonsToMD.apply($("form[action='/Preferences/Edit'] button.inputReplaceButton").get(0)),$("form[action='/Preferences/Edit'] button.inputReplaceButton").parent().css("width","0px"),$("div.table-form select").each(function(){var e=$('<input type="checkbox" id="checkbox_'+$(this).attr("id")+'" class="mdl-switch__input">'),t=$('<span class="mdl-switch__label"></span>'),n=$('<label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="checkbox_'+$(this).attr("id")+'">').append(e,t);$(this).after(n),$(this).hide(),"Yes"==$(this).val()&&e.attr("checked","checked"),componentHandler.upgradeElement(n.get(0))}),$("#settings").fadeIn("fast"),$("form[action='/Preferences/Edit'] button.inputReplaceButton").click(function(){$("div.table-form select").each(function(){$("#checkbox_"+$(this).attr("id")).parent().hasClass("is-checked")?$(this).val("Yes"):$(this).val("No")})})})}function SetUpTimeForStudent(){isStudent&&($("tr[id]").not("[class=future]").each(function(e){var t=$(this).children("td.time").first().text();$(this).children("td.time").last().text(t)}),$("label#currentTime").text(GetAlreadyWorkedTimeForMonth_ForStudent()),$("label#reportTimeForMonth").text(GetSumReportTimeForMonth_ForStudent()),$("label#currentTime_week").text(GetCurrentTimeForWeek_ForStudent()))}function SetTableHeightForTime(){isMonth?$("table.full-size tbody").height($(window).height()-492):$("table.full-size tbody").height($(window).height()-526)}var isMonth=!0,isStudent=!1;$(document).ready(function(){IsReportOnPage()?RemoveColumnsWhenReportIsOnPage():RemoveColumnsWhenThereIsNoReport(),SeparateStartAndFinish(),RemoveUnnesessaryBlocks(),AddRowBetweenWeeksWithWeekNumber(),WriteFullNamesOfDays(),CreateSettings(),ShowTableFullSizeAndHolidayBox();var e=!1;$(window).resize(function(){SetTableHeightForTime()}).resize(),$("table.full-size th").first().removeAttr("colspan").addClass("weekday").after("<th class='monthday number'>№</th>"),CreateFlex(),AddConclusionForMonth(),$("tr.intervalRow").click(function(){if(!isMonth)return $(".intervalRow").show(),$("tr[id]").not("[class=future]").show(),$(".dayoff").show(),RemoveConclusionForWeek(),AddConclusionForMonth(),isMonth=!0,e=!1,$(".buttonDiv").remove(),$(window).resize(),void SetUpTimeForStudent();$(this).prevAll().each(function(){$(this).hide()}),$(this).nextAll().each(function(){"intervalRow"==$(this).attr("class")&&(e=!0),e&&$(this).hide()});var t=$("<button></button>",{"class":"resetButton",type:"button"}).append("Вернуться к месяцу...");ChangeButtonsToMD.apply(t.get(0));var n=$("<div></div>",{"class":"buttonDiv"}).append("<br>",t),i=$("<div></div>",{"class":"barrier"});RemoveConclusionForMonth(),AddConclusionForWeek(),isMonth=!1,$(window).resize(),SetUpTimeForStudent(),$("table.full-size").parent().append(i,n),$(".resetButton").click(function(){isMonth||($(".intervalRow").show(),$("tr[id]").not("[class=future]").show(),$(".dayoff").show(),RemoveConclusionForWeek(),AddConclusionForMonth(),isMonth=!0,e=!1,$(".buttonDiv").remove(),$(window).resize(),SetUpTimeForStudent())})})});